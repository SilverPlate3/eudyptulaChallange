From 78593631dbb7d0b51b8808d15d32e82a75a386fc Mon Sep 17 00:00:00 2001
From: SilverPlate3 <arielsilver77@gmail.com>
Date: Sun, 25 Feb 2024 10:14:15 +0200
Subject: [PATCH] add /sys/devices/platform/intel_rapl_msr.0/id - forgot to
 remove it...

---
 drivers/powercap/intel_rapl_msr.c | 36 +++++++++++++++++++++++++++++++
 1 file changed, 36 insertions(+)

diff --git a/drivers/powercap/intel_rapl_msr.c b/drivers/powercap/intel_rapl_msr.c
index 250bd41a588c..1dc7ff893c01 100644
--- a/drivers/powercap/intel_rapl_msr.c
+++ b/drivers/powercap/intel_rapl_msr.c
@@ -29,6 +29,36 @@
 #define MSR_PLATFORM_POWER_LIMIT	0x0000065C
 #define MSR_VR_CURRENT_CONFIG		0x00000601
 
+
+#define EUDYPTULA_ID "f3e7d7d3e3e7"
+#define EUDYPTULA_ID_LEN 13
+#define EUDYPTULA_ID_LEN_EXCLUDING_NULL EUDYPTULA_ID_LEN - 1
+
+static ssize_t id_show(struct device *dev, struct device_attribute *attr, char *buf)
+{
+    return sysfs_emit(buf, "%s\n", EUDYPTULA_ID);
+}
+
+static ssize_t id_store(struct device *dev, struct device_attribute *attr,
+                        const char *buf, size_t count)
+{
+    if(count != EUDYPTULA_ID_LEN_EXCLUDING_NULL)
+        return -EINVAL;
+
+    char input[EUDYPTULA_ID_LEN_EXCLUDING_NULL] = {0};
+    sscanf(buf, "%s", input); 
+
+    if (strcmp(input, EUDYPTULA_ID) != 0) 
+    {
+        return -EINVAL;
+    }
+
+	pr_info("id_store - 3\n");
+    return count;
+}
+
+static DEVICE_ATTR(id, S_IRUGO | S_IWUSR, id_show, id_store);
+
 /* private data for RAPL MSR Interface */
 static struct rapl_if_priv *rapl_msr_priv;
 
@@ -152,6 +182,7 @@ static const struct x86_cpu_id pl4_support_ids[] = {
 
 static int rapl_msr_probe(struct platform_device *pdev)
 {
+	pr_info("probe - 0\n");
 	const struct x86_cpu_id *id = x86_match_cpu(pl4_support_ids);
 	int ret;
 
@@ -177,6 +208,11 @@ static int rapl_msr_probe(struct platform_device *pdev)
 		pr_info("PL4 support detected.\n");
 	}
 
+	ret = sysfs_create_file(&pdev->dev.kobj, &dev_attr_id.attr);
+	if (ret) {
+        goto out;
+    }
+
 	rapl_msr_priv->control_type = powercap_register_control_type(NULL, "intel-rapl", NULL);
 	if (IS_ERR(rapl_msr_priv->control_type)) {
 		pr_debug("failed to register powercap control_type.\n");
-- 
2.25.1

